<!DOCTYPE html>
<html lang="en">
<head>
	<base href="/">
	<meta charset="utf-8">
	<title>my Ajax Crypto Prices</title>
	
	<style>				
		body {			
			background-color:#222;			
			font: 75% "Helvetica Neue", Helvetica, "Arial Unicode MS", Arial, sans-serif;			
			color:white		
		}	    
		#graphic:-webkit-full-screen {			
			width: 100%;	        
			height: 100%;	        
			background-color: black;	    
		}	
		
		.greyBackground	{
			display: inline-block;
			margin-bottom: 10px;
    		background-color: #555;
			color:black;	
			padding: 10px 10px 10px 10px;
		}
	</style>
	
	<!--
	* 2017 Gilemon
	*  @author    Gilemon
	-->
	
	<!-- Scripts -->

	<script type="text/javascript">
		var loc = window.location.pathname;
		var dir = loc.substring(0, loc.lastIndexOf('/'));
		var head= document.getElementsByTagName('head')[0];
		var first = true;
		var symbolToStructArray = [];
		var last = 0;
		var loaded = 0;
		var tableContent = [];
		var tableContentT = '';
		
		var currencyCss = "currencies_views_all_0.css"
		var cssfile = document.createElement('link');
		cssfile.rel = "stylesheet";
		cssfile.type = "text/css";
		cssfile.href = dir + "/" + currencyCss;
		document.getElementsByTagName("head")[0].appendChild(cssfile);
		
		var script= document.createElement('script');
		script.type= 'text/javascript';
		script.src= dir + "/jquery-3.2.1.min.js?dev=" + Math.floor(Math.random() * 100);
		head.appendChild(script);
		script.onreadystatechange= function () 
		{
			if ((this.readyState == 'complete')||(this.readyState == 'loaded'))
			{
				init();
			}
		}
		script.onload = init;
		
		function init()
		{
			console.log( "start!" + dir );
			
			var script= document.createElement('script');
			script.type= 'text/javascript';
			script.src= dir + "/conf.js?dev=" + Math.floor(Math.random() * 100);
			head.appendChild(script);
			script.onreadystatechange= function () 
			{
				if ((this.readyState == 'complete')||(this.readyState == 'loaded'))
				{
					init2();
				}
			}
			script.onload = init2;
		}
		
		function init2()
		{
			console.log("INIT CONF");
			console.log(cryptoArray);
			
			for (var i in cryptoArray)
			{
				symbolToStructArray[cryptoArray[i].symbol] = cryptoArray[i];
				symbolToStructArray[cryptoArray[i].symbol].i = i;
				last = parseInt(i) + 1;
			}
			
		    console.log( "ready!" );
			
			for (var i in cryptoArray)
			{
				$("#prices").append("<div id=\"crypto"+i+"\"></div>");
			}
			for (var i in cryptoArray)
			{
				var lurl = API_URL+cryptoArray[i].symbol+"-"+currencyCompare.symbol;
				var lname = cryptoArray[i].name;
				console.log(lname);
				setTimeout(getAjaxRequest, i * 500, lurl, lname, i);
			}
		}	
			
		function getAjaxRequest(lurl, lname, i)
		{		
			$.ajax({
			  url: lurl,
			  context: document.body,
			  error: function(jqXHR,error, errorThrown) {  
				               if(jqXHR.status&&jqXHR.status==400){
				                    alert(jqXHR.responseText + lurl); 
				               }else{
				                   alert("Something went wrong" + lurl);
				               }
				          }
			}).done(function( data ) 
			{
				if(first)
				{  
					$("#loading").html("");
					first = false;
				}
				var priceChangeText = "";
				var tolower = data.ticker.base.toLowerCase();
				if(typeof symbolToStructArray[tolower].refVal !== "undefined")
				{
					console.log(symbolToStructArray[tolower].name);
					var changeDiff = data.ticker.price - symbolToStructArray[tolower].refVal;
					var changeVal =  (changeDiff/symbolToStructArray[tolower].refVal) * 100;
					changeVal = Math.round(changeVal*100)/100;
					var span = '<span style="color:red">';
					if(changeDiff>0) span = '<span style="color:green">';
					priceChangeText = " " + span +"(" + changeVal + "%)</span>";
				}
				var symbol = "1 &#215; " + symbolToStructArray[tolower].name;
				var classname = 's-s-'+symbolToStructArray[tolower].name.toLowerCase();
				if(selectorInStyleSheet(currencyCss, '.' + classname))
				{
					symbol = "<div class=\"" + classname + " currency-logo-sprite\" style=\"display:inline-block;margin-bottom: -3px\"></div>";
				}
				else
				{
					var regex = /\s+/gi;
					classname = classname.replace(regex , "-");
					if(selectorInStyleSheet(currencyCss, '.' + classname))
					{
						symbol = "<div class=\"" + classname + " currency-logo-sprite\" style=\"display:inline-block;margin-bottom: -3px\"></div>";
					}
					else
					{
						var regex = /\s+/gi;
						classname = 's-s-'+symbolToStructArray[tolower].name.toLowerCase().replace(regex , "");
						if(selectorInStyleSheet(currencyCss, '.' + classname))
						{
							symbol = "<div class=\"" + classname + " currency-logo-sprite\" style=\"display:inline-block;margin-bottom: -3px\"></div>";
						}
						else
						{
							console.log(classname + " NOT FOUND in CSS");
						}
					}
				}
				
				console.log(data.ticker.price + " " + symbolToStructArray[tolower].i);
				$("#crypto"+symbolToStructArray[tolower].i).html("<span>" + symbol + " = " + data.ticker.price + " " + currencyCompare.name + priceChangeText + "</span>");
				
				tableContent[symbolToStructArray[tolower].i] = data.ticker.price;
				loaded++;
				if(loaded == last)
				{
					console.log("ALL loaded ");
					for (var i in tableContent)
					{
						tableContentT += tableContent[i] + "<br>";
					}
					$("#tableContent").html(tableContentT);

					var mybutt = document.querySelector('.js-copy-btn');
					mybutt.addEventListener('click', function(event) {copyTextToClipboard(tableContentT);});
					mybutt.style.visibility = 'visible';
				}
			});
		}
		
		function copyTextToClipboard(text) 
		{
		  var textArea = document.createElement("textarea");

		  // Place in top-left corner of screen regardless of scroll position.
		  textArea.style.position = 'fixed';
		  textArea.style.top = 0;
		  textArea.style.left = 0;

		  // Ensure it has a small width and height. Setting to 1px / 1em
		  // doesn't work as this gives a negative w/h on some browsers.
		  textArea.style.width = '2em';
		  textArea.style.height = '2em';

		  // We don't need padding, reducing the size if it does flash render.
		  textArea.style.padding = 0;

		  // Clean up any borders.
		  textArea.style.border = 'none';
		  textArea.style.outline = 'none';
		  textArea.style.boxShadow = 'none';

		  // Avoid flash of white box if rendered for any reason.
		  textArea.style.background = 'transparent';
		  
		  var regex = /<br\s*[\/]?>/gi;
		  textArea.value = text.replace(regex, "\n");

		  document.body.appendChild(textArea);

		  textArea.select();

		  try {
		    var successful = document.execCommand('copy');
			document.execCommand("RemoveFormat");
		    var msg = successful ? 'successful' : 'unsuccessful';
		    console.log('Copying text command was ' + msg);
		  } catch (err) {
		    console.log('Oops, unable to copy');
		  }

		  document.body.removeChild(textArea);
		}
		
		function selectorInStyleSheet(styleSheetName, selector) {
		    /*
		     * Get the index of 'styleSheetName' from the document.styleSheets object
		     */
		    for (var i = 0; i < document.styleSheets.length; i++) {
		        var thisStyleSheet = document.styleSheets[i].href ? document.styleSheets[i].href.replace(/^.*[\\\/]/, '') : '';
		        if (thisStyleSheet == styleSheetName) { var idx = i; break; }
		    }
		    if (!idx) return false; // We can't find the specified stylesheet

		    /*
		     * Check the stylesheet for the specified selector
		     */
		    var styleSheet = document.styleSheets[idx];
		    var cssRules = styleSheet.rules ? styleSheet.rules : styleSheet.cssRules;
		    for (var i = 0; i < cssRules.length; ++i) {
		        if(cssRules[i].selectorText == selector) return true;
		    }
		    return false;
		}
		
	</script>
	<!-- end scripts -->
</head>		
<body>
	<!-- Main Container -->
	<div class="main-container">
			<!-- Container -->
			<div class="container">
				<a href="/" class="logo"></a>
				<!-- Content -->
				<div ng-view class="content">
					<center>
						<div id="prices" style="display: inline-block; text-align: left;">
							<div id="loading">loading crypto feeds...</div>
						</div>
						<br>
						<h3>Values for copy/paste:</h3>
						<div id="tableContent" class="greyBackground">loading...</div>
						<br><button class="js-copy-btn" style="visibility: hidden;">Copy to clipboard</button>
					</center>
				</div>
				<!-- end Content -->
			</div>
			<!-- end Container -->
	</div><!-- end Main Container -->
</body>
</html>